# èŠå¤©å®¤ç³»ç»Ÿå‡çº§è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

å°†ç°æœ‰çš„å•å‘AIç”ŸæˆèŠå¤©é¡µé¢å‡çº§ä¸ºåŒå‘äº¤äº’çš„ç©¿æ­å»ºè®®èŠå¤©å®¤ï¼Œæ”¯æŒç”¨æˆ·è‡ªç”±æé—®å’ŒAIå®æ—¶å›å¤ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å‰ç«¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Reactå‰ç«¯                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Chat UI    â”‚  â”‚  Input Box  â”‚  â”‚  Message History    â”‚  â”‚
â”‚  â”‚  Component  â”‚  â”‚  Component  â”‚  â”‚  Component          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  File       â”‚  â”‚  Voice      â”‚  â”‚  Style Preference   â”‚  â”‚
â”‚  â”‚  Upload     â”‚  â”‚  Input      â”‚  â”‚  Panel              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åç«¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Next.js API Layer                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WebSocket  â”‚  â”‚  Chat API   â”‚  â”‚  File Upload API    â”‚  â”‚
â”‚  â”‚  Handler    â”‚  â”‚  Endpoints  â”‚  â”‚  Endpoints          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  LangChain  â”‚  â”‚  Message    â”‚  â”‚  Session            â”‚  â”‚
â”‚  â”‚  Integrationâ”‚  â”‚  Queue      â”‚  â”‚  Management         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### LangChainä»£ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LangChain Agent                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Chat       â”‚  â”‚  Style      â”‚  â”‚  Image Analysis     â”‚  â”‚
â”‚  â”‚  Memory     â”‚  â”‚  Knowledge  â”‚  â”‚  Tool               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Outfit     â”‚  â”‚  Trend      â”‚  â”‚  Personalization    â”‚  â”‚
â”‚  â”‚  Generator  â”‚  â”‚  Analyzer   â”‚  â”‚  Engine             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶å®ç°

### 1. æ¶ˆæ¯ç±»å‹ç³»ç»Ÿ

```typescript
// æ‰©å±•ç°æœ‰çš„ChatMessageç±»å‹
interface ChatMessage {
  id: string;
  type: 'text' | 'image' | 'loading' | 'audio' | 'file' | 'suggestion';
  role: 'ai' | 'user' | 'system';
  content?: string;
  imageUrl?: string;
  audioUrl?: string;
  fileUrl?: string;
  metadata?: {
    suggestions?: string[];
    confidence?: number;
    styleAnalysis?: StyleAnalysis;
    context?: ConversationContext;
  };
  timestamp: Date;
  replyTo?: string; // å›å¤æ¶ˆæ¯ID
}

interface StyleAnalysis {
  bodyType: string;
  colorPalette: string[];
  preferredStyles: string[];
  occasion: string;
  season: string;
}

interface ConversationContext {
  userPreferences: UserPreferences;
  currentOutfit?: OutfitData;
  previousSuggestions: string[];
  sessionId: string;
}
```

### 2. å®æ—¶é€šä¿¡ç³»ç»Ÿ

```typescript
// WebSocketè¿æ¥ç®¡ç†
class ChatWebSocketManager {
  private ws: WebSocket | null = null;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  connect(sessionId: string) {
    this.ws = new WebSocket(`wss://your-domain.com/api/chat/ws?session=${sessionId}`);

    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      this.handleMessage(message);
    };

    this.ws.onclose = () => {
      this.handleReconnect();
    };
  }

  sendMessage(message: ChatMessage) {
    if (this.ws?.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(message));
    }
  }

  private handleReconnect() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      setTimeout(() => {
        this.reconnectAttempts++;
        this.connect(this.sessionId);
      }, 1000 * this.reconnectAttempts);
    }
  }
}
```

### 3. LangChain Agentå®ç°

```python
# åç«¯Pythonä»£ç ç¤ºä¾‹ (å¯ä»¥ç”¨Node.jså®ç°)
from langchain.agents import create_openai_functions_agent
from langchain.tools import Tool
from langchain.memory import ConversationBufferWindowMemory
from langchain_openai import ChatOpenAI

class StyleChatAgent:
    def __init__(self):
        self.llm = ChatOpenAI(model="gpt-4-turbo")
        self.memory = ConversationBufferWindowMemory(k=10)
        self.tools = self._create_tools()
        self.agent = create_openai_functions_agent(
            llm=self.llm,
            tools=self.tools,
            memory=self.memory
        )

    def _create_tools(self):
        return [
            Tool(
                name="style_analyzer",
                description="åˆ†æç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼Œè¯†åˆ«æœè£…é£æ ¼å’Œæ­é…å»ºè®®",
                func=self.analyze_style
            ),
            Tool(
                name="outfit_generator",
                description="æ ¹æ®ç”¨æˆ·åå¥½ç”Ÿæˆç©¿æ­å»ºè®®",
                func=self.generate_outfit
            ),
            Tool(
                name="trend_lookup",
                description="æŸ¥è¯¢æœ€æ–°çš„æ—¶å°šè¶‹åŠ¿å’Œæµè¡Œå…ƒç´ ",
                func=self.lookup_trends
            ),
            Tool(
                name="color_matcher",
                description="æä¾›è‰²å½©æ­é…å»ºè®®",
                func=self.match_colors
            )
        ]

    async def chat(self, user_input: str, context: dict):
        response = await self.agent.ainvoke({
            "input": user_input,
            "context": context
        })
        return response["output"]
```

## ğŸ“± å‰ç«¯ç»„ä»¶å‡çº§

### 1. æ™ºèƒ½è¾“å…¥æ¡†

```typescript
// components/chat/SmartInputBox.tsx
interface SmartInputBoxProps {
  onSendMessage: (message: string) => void;
  onFileUpload: (file: File) => void;
  onVoiceRecording: (audio: Blob) => void;
  suggestions?: string[];
}

const SmartInputBox: React.FC<SmartInputBoxProps> = ({
  onSendMessage,
  onFileUpload,
  onVoiceRecording,
  suggestions = []
}) => {
  const [input, setInput] = useState('');
  const [isRecording, setIsRecording] = useState(false);
  const [showSuggestions, setShowSuggestions] = useState(false);

  return (
    <div className="smart-input-container">
      {/* å¿«æ·å»ºè®®æ ‡ç­¾ */}
      {suggestions.length > 0 && (
        <div className="suggestions-panel">
          {suggestions.map((suggestion, index) => (
            <button
              key={index}
              onClick={() => onSendMessage(suggestion)}
              className="suggestion-tag"
            >
              {suggestion}
            </button>
          ))}
        </div>
      )}

      {/* è¾“å…¥æ¡† */}
      <div className="input-area">
        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="è¯¢é—®ç©¿æ­å»ºè®®..."
          onKeyPress={(e) => e.key === 'Enter' && handleSend()}
        />

        {/* åŠŸèƒ½æŒ‰é’® */}
        <div className="action-buttons">
          <FileUploadButton onUpload={onFileUpload} />
          <VoiceRecordButton
            isRecording={isRecording}
            onRecording={onVoiceRecording}
          />
          <SendButton onClick={handleSend} disabled={!input.trim()} />
        </div>
      </div>
    </div>
  );
};
```

### 2. å¢å¼ºçš„èŠå¤©æ°”æ³¡

```typescript
// components/chat/EnhancedChatBubble.tsx
const EnhancedChatBubble: React.FC<{message: ChatMessage}> = ({ message }) => {
  const isAI = message.role === 'ai';

  return (
    <div className={`chat-bubble ${isAI ? 'ai-bubble' : 'user-bubble'}`}>
      {/* AIå¤´åƒå’ŒçŠ¶æ€ */}
      {isAI && <AIAvatar status={message.type === 'loading' ? 'thinking' : 'active'} />}

      {/* æ¶ˆæ¯å†…å®¹ */}
      <div className="message-content">
        {message.type === 'text' && (
          <TextMessage content={message.content} />
        )}

        {message.type === 'image' && (
          <ImageMessage
            src={message.imageUrl}
            onAnalyze={() => analyzeImage(message.imageUrl)}
          />
        )}

        {message.type === 'suggestion' && (
          <SuggestionMessage
            suggestions={message.metadata?.suggestions || []}
            onSelect={handleSuggestionSelect}
          />
        )}

        {/* æ¶ˆæ¯æ“ä½œ */}
        <MessageActions
          message={message}
          onReply={handleReply}
          onReact={handleReact}
          onShare={handleShare}
        />
      </div>

      {/* æ—¶é—´æˆ³ */}
      <div className="timestamp">
        {formatTime(message.timestamp)}
      </div>
    </div>
  );
};
```

## ğŸš€ APIç«¯ç‚¹è®¾è®¡

### 1. èŠå¤©ç›¸å…³API

```typescript
// app/api/chat/route.ts
export async function POST(request: Request) {
  const { message, sessionId, context } = await request.json();

  try {
    // è°ƒç”¨LangChain Agent
    const response = await chatAgent.process({
      message,
      sessionId,
      context
    });

    return Response.json({
      success: true,
      response,
      sessionId
    });
  } catch (error) {
    return Response.json({
      success: false,
      error: error.message
    }, { status: 500 });
  }
}

// app/api/chat/ws/route.ts - WebSocketå¤„ç†
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const sessionId = searchParams.get('session');

  // å‡çº§åˆ°WebSocketè¿æ¥
  const upgrade = request.headers.get('upgrade');
  if (upgrade !== 'websocket') {
    return new Response('Expected websocket', { status: 400 });
  }

  // WebSocketè¿æ¥å¤„ç†é€»è¾‘
  // ...
}
```

### 2. æ–‡ä»¶ä¸Šä¼ å’Œåˆ†æAPI

```typescript
// app/api/chat/upload/route.ts
export async function POST(request: Request) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  const sessionId = formData.get('sessionId') as string;

  try {
    // ä¸Šä¼ åˆ°Vercel Blob
    const blob = await put(file.name, file, {
      access: 'public',
    });

    // åˆ†æå›¾ç‰‡å†…å®¹
    const analysis = await analyzeImage(blob.url);

    return Response.json({
      success: true,
      fileUrl: blob.url,
      analysis
    });
  } catch (error) {
    return Response.json({
      success: false,
      error: error.message
    }, { status: 500 });
  }
}
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒå¢å¼º

### 1. æ™ºèƒ½å»ºè®®ç³»ç»Ÿ

```typescript
// lib/suggestions.ts
export class SmartSuggestionEngine {
  static generateSuggestions(context: ConversationContext): string[] {
    const suggestions = [];

    // åŸºäºå½“å‰ä¸Šä¸‹æ–‡ç”Ÿæˆå»ºè®®
    if (context.currentOutfit) {
      suggestions.push("è¿™å¥—æ­é…æ€ä¹ˆæ ·ï¼Ÿ");
      suggestions.push("æœ‰ä»€ä¹ˆé…é¥°å»ºè®®å—ï¼Ÿ");
      suggestions.push("é€‚åˆä»€ä¹ˆåœºåˆï¼Ÿ");
    }

    // åŸºäºå†å²å¯¹è¯ç”Ÿæˆå»ºè®®
    if (context.previousSuggestions.length > 0) {
      suggestions.push("ç»™æˆ‘çœ‹çœ‹åˆ«çš„é£æ ¼");
      suggestions.push("è¿™ä¸ªé¢œè‰²æ­é…ä»€ä¹ˆå¥½ï¼Ÿ");
    }

    // é€šç”¨å»ºè®®
    suggestions.push(
      "æ¨èä¸€äº›æ—¶å°šå•å“",
      "åˆ†ææˆ‘çš„ç©¿æ­é£æ ¼",
      "æ˜¥å­£æµè¡Œè¶‹åŠ¿",
      "çº¦ä¼šç©¿æ­å»ºè®®"
    );

    return suggestions.slice(0, 4); // é™åˆ¶æ˜¾ç¤ºæ•°é‡
  }
}
```

### 2. ä¸ªæ€§åŒ–è®°å¿†ç³»ç»Ÿ

```typescript
// lib/memory.ts
export class ConversationMemory {
  private memory: Map<string, ConversationContext> = new Map();

  async saveContext(sessionId: string, context: ConversationContext) {
    // ä¿å­˜åˆ°Vercel KV
    await kv.set(`chat:${sessionId}`, JSON.stringify(context));
    this.memory.set(sessionId, context);
  }

  async getContext(sessionId: string): Promise<ConversationContext | null> {
    // å…ˆä»å†…å­˜ä¸­è·å–
    if (this.memory.has(sessionId)) {
      return this.memory.get(sessionId)!;
    }

    // ä»KVä¸­è·å–
    const stored = await kv.get(`chat:${sessionId}`);
    if (stored) {
      const context = JSON.parse(stored as string);
      this.memory.set(sessionId, context);
      return context;
    }

    return null;
  }

  async updateUserPreferences(sessionId: string, preferences: Partial<UserPreferences>) {
    const context = await this.getContext(sessionId);
    if (context) {
      context.userPreferences = { ...context.userPreferences, ...preferences };
      await this.saveContext(sessionId, context);
    }
  }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ¶ˆæ¯æ‡’åŠ è½½

```typescript
// hooks/useMessagePagination.ts
export const useMessagePagination = (sessionId: string) => {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [loading, setLoading] = useState(false);
  const [hasMore, setHasMore] = useState(true);

  const loadMoreMessages = useCallback(async () => {
    if (loading || !hasMore) return;

    setLoading(true);
    try {
      const response = await fetch(`/api/chat/messages?session=${sessionId}&offset=${messages.length}`);
      const newMessages = await response.json();

      if (newMessages.length === 0) {
        setHasMore(false);
      } else {
        setMessages(prev => [...newMessages, ...prev]);
      }
    } catch (error) {
      console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  }, [sessionId, messages.length, loading, hasMore]);

  return { messages, loading, hasMore, loadMoreMessages };
};
```

### 2. å›¾ç‰‡ä¼˜åŒ–

```typescript
// components/chat/OptimizedImage.tsx
const OptimizedImage: React.FC<{
  src: string;
  alt: string;
  onClick?: () => void;
}> = ({ src, alt, onClick }) => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(false);

  return (
    <div className="optimized-image-container">
      {loading && <ImageSkeleton />}
      {error && <ImageError onRetry={() => setError(false)} />}

      <img
        src={src}
        alt={alt}
        loading="lazy"
        onClick={onClick}
        onLoad={() => setLoading(false)}
        onError={() => {
          setLoading(false);
          setError(true);
        }}
        className={`optimized-image ${loading ? 'loading' : ''}`}
      />
    </div>
  );
};
```

## ğŸ” å®‰å…¨å’Œéšç§

### 1. ä¼šè¯ç®¡ç†

```typescript
// lib/session.ts
export class SessionManager {
  static async createSession(userId?: string): Promise<string> {
    const sessionId = nanoid();
    const session = {
      id: sessionId,
      userId,
      createdAt: new Date(),
      lastActivity: new Date(),
      messages: [],
      context: {}
    };

    await kv.set(`session:${sessionId}`, JSON.stringify(session));
    return sessionId;
  }

  static async validateSession(sessionId: string): Promise<boolean> {
    const session = await kv.get(`session:${sessionId}`);
    if (!session) return false;

    const sessionData = JSON.parse(session as string);
    const now = Date.now();
    const lastActivity = new Date(sessionData.lastActivity).getTime();

    // 24å°æ—¶è¿‡æœŸ
    return (now - lastActivity) < 24 * 60 * 60 * 1000;
  }

  static async updateActivity(sessionId: string) {
    const session = await kv.get(`session:${sessionId}`);
    if (session) {
      const sessionData = JSON.parse(session as string);
      sessionData.lastActivity = new Date();
      await kv.set(`session:${sessionId}`, JSON.stringify(sessionData));
    }
  }
}
```

### 2. å†…å®¹è¿‡æ»¤

```typescript
// lib/content-filter.ts
export class ContentFilter {
  static async filterMessage(content: string): Promise<{
    isValid: boolean;
    filteredContent: string;
    reasons?: string[];
  }> {
    const reasons: string[] = [];
    let filteredContent = content;

    // æ£€æŸ¥æ•æ„Ÿè¯
    const sensitiveWords = ['ä¸å½“è¯æ±‡1', 'ä¸å½“è¯æ±‡2'];
    for (const word of sensitiveWords) {
      if (content.includes(word)) {
        reasons.push(`åŒ…å«æ•æ„Ÿè¯: ${word}`);
        filteredContent = filteredContent.replace(word, '***');
      }
    }

    // é•¿åº¦æ£€æŸ¥
    if (content.length > 1000) {
      reasons.push('æ¶ˆæ¯è¿‡é•¿');
      return { isValid: false, filteredContent, reasons };
    }

    return {
      isValid: reasons.length === 0,
      filteredContent,
      reasons: reasons.length > 0 ? reasons : undefined
    };
  }
}
```

## ğŸ¯ å®æ–½æ­¥éª¤

### é˜¶æ®µ1: åŸºç¡€æ¶æ„å‡çº§ï¼ˆ1-2å‘¨ï¼‰

1. å®‰è£…LangChainä¾èµ–
2. åˆ›å»ºWebSocketè¿æ¥
3. æ‰©å±•æ¶ˆæ¯ç±»å‹ç³»ç»Ÿ
4. åŸºç¡€UIç»„ä»¶å‡çº§

### é˜¶æ®µ2: AI Agentå¼€å‘ï¼ˆ2-3å‘¨ï¼‰

1. è®¾è®¡LangChainå·¥å…·é“¾
2. å®ç°ç©¿æ­çŸ¥è¯†åº“
3. å¼€å‘ä¸ªæ€§åŒ–æ¨èå¼•æ“
4. é›†æˆå›¾ç‰‡åˆ†æåŠŸèƒ½

### é˜¶æ®µ3: ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. æ™ºèƒ½å»ºè®®ç³»ç»Ÿ
2. è¯­éŸ³è¾“å…¥åŠŸèƒ½
3. æ¶ˆæ¯æ‡’åŠ è½½
4. æ€§èƒ½ä¼˜åŒ–

### é˜¶æ®µ4: æµ‹è¯•å’Œéƒ¨ç½²ï¼ˆ1å‘¨ï¼‰

1. ç«¯åˆ°ç«¯æµ‹è¯•
2. æ€§èƒ½æµ‹è¯•
3. å®‰å…¨æµ‹è¯•
4. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

- **ç”¨æˆ·å‚ä¸åº¦**: æå‡50%ä»¥ä¸Šçš„å¯¹è¯æ—¶é•¿
- **æ»¡æ„åº¦**: æ›´ä¸ªæ€§åŒ–çš„å»ºè®®å’Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- **è½¬åŒ–ç‡**: æé«˜ç”¨æˆ·å¯¹å»ºè®®çš„é‡‡çº³ç‡
- **æŠ€æœ¯æŒ‡æ ‡**:
  - å“åº”æ—¶é—´ < 2ç§’
  - æ¶ˆæ¯å¤„ç†èƒ½åŠ› > 1000æ¡/åˆ†é’Ÿ
  - ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%

è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆå°†ç°æœ‰çš„èŠå¤©é¡µé¢å‡çº§ä¸ºä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œã€æ™ºèƒ½åŒ–çš„ç©¿æ­å»ºè®®èŠå¤©å®¤ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ›´å‡†ç¡®çš„AIå»ºè®®ã€‚
