# åˆ†é˜¶æ®µå»¶è¿ŸåŠ è½½æ¶æ„è®¾è®¡

**æ—¥æœŸ**: 2025å¹´7æœˆ28æ—¥  
**ç›®æ ‡**: é€šè¿‡åˆ†é˜¶æ®µå¤„ç†å®ç°å¿«é€Ÿå“åº”å’ŒæŒ‰éœ€åŠ è½½ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒå’Œèµ„æºåˆ©ç”¨

## 1. è®¾è®¡åŸç†

### æ ¸å¿ƒæ€æƒ³
å°†ä¼ ç»Ÿçš„"ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰å†…å®¹"æ”¹ä¸º"åˆ†é˜¶æ®µæŒ‰éœ€å¤„ç†"ï¼Œå®ç°ï¼š
- **å¿«é€Ÿå“åº”**: ä»»åŠ¡åˆ›å»ºç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…AIå¤„ç†
- **æŒ‰éœ€åŠ è½½**: åªç”Ÿæˆç”¨æˆ·å…³å¿ƒçš„å†…å®¹ï¼ŒèŠ‚çœè®¡ç®—èµ„æº
- **æ¸è¿›ä½“éªŒ**: ç”¨æˆ·å…ˆçœ‹åˆ°å»ºè®®ï¼Œå†é€‰æ‹©æ„Ÿå…´è¶£çš„ç”Ÿæˆå›¾ç‰‡
- **å¹¶å‘æ§åˆ¶**: é€šè¿‡pipelineé”æœºåˆ¶é¿å…é‡å¤è§¦å‘

### æ¶æ„ä¼˜åŠ¿

| ä¼ ç»Ÿæ¶æ„ | åˆ†é˜¶æ®µæ¶æ„ |
|---------|-----------|
| ç”¨æˆ·ç­‰å¾…æ‰€æœ‰å¤„ç†å®Œæˆ | ç«‹å³è¿”å›jobIdï¼Œå¼‚æ­¥å¤„ç† |
| ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰å†…å®¹ | æŒ‰éœ€ç”Ÿæˆï¼ŒèŠ‚çœèµ„æº |
| å›ºå®šæµç¨‹ï¼Œæ— ç”¨æˆ·é€‰æ‹© | ç”¨æˆ·å¯é€‰æ‹©æ€§ç”Ÿæˆ |
| å®¹æ˜“è¶…æ—¶å’Œå¤±è´¥ | å®¹é”™æ€§å¼ºï¼Œå¯é‡è¯• |

## 2. åˆ†é˜¶æ®µå¤„ç†è¯¦è§£

### é˜¶æ®µ1: `/api/generation/start/route.ts` - ä»»åŠ¡åˆ›å»ºé˜¶æ®µ

**åŠŸèƒ½**: åˆ›å»ºå…¨æ–°çš„å›¾åƒç”Ÿæˆä»»åŠ¡
**ç›®æ ‡**: å¿«é€Ÿå“åº”ï¼Œæœ€å°åŒ–å¿…è¦å·¥ä½œ

```typescript
// åˆ›å»ºåˆå§‹Jobï¼ŒçŠ¶æ€ä¸º'pending'ï¼Œæ— suggestions
const newJob: Job = {
  jobId,
  userId,
  status: 'pending', // åˆå§‹çŠ¶æ€
  suggestions: [], // ç©ºæ•°ç»„ï¼Œåç»­ç”Ÿæˆ
  input: {
    humanImage: { url: humanImageBlob.url, ... },
    garmentImage: { url: garmentImageBlob.url, ... },
    generationMode,
    occasion,
    userProfile,
    customPrompt,
    stylePrompt,
  },
  createdAt: now,
  updatedAt: now,
};

// è¢«æ³¨é‡Šæ‰çš„pipelineè°ƒç”¨
// runImageGenerationPipeline(jobId, 0);
// console.log(`[Job ${jobId}] Background pipeline started for suggestion 0.`);
```

**ä¸ºä»€ä¹ˆpipelineè¢«æ³¨é‡Šæ‰**:
- åªåš**æœ€å°å¿…è¦å·¥ä½œ**: ä¸Šä¼ å›¾ç‰‡ã€åˆ›å»ºJobè®°å½•
- Jobåˆå§‹çŠ¶æ€ä¸º`'pending'`ï¼Œsuggestionsæ•°ç»„ä¸º**ç©º**
- æ³¨é‡Šä¸­è¯´æ˜ï¼š"AI processing will start on first status poll"
- ç›®çš„æ˜¯**å¿«é€Ÿå“åº”**ç”¨æˆ·è¯·æ±‚ï¼Œç«‹å³è¿”å›jobId

### é˜¶æ®µ2: `/api/generation/status/route.ts` - å»ºè®®ç”Ÿæˆé˜¶æ®µ

**åŠŸèƒ½**: ç”ŸæˆAIé£æ ¼å»ºè®®ï¼Œè‡ªåŠ¨å¯åŠ¨ç¬¬ä¸€ä¸ªå»ºè®®çš„å›¾åƒç”Ÿæˆ
**ç›®æ ‡**: æä¾›åˆå§‹å†…å®¹ï¼Œå¼•å¯¼ç”¨æˆ·äº¤äº’

```typescript
// å½“é¦–æ¬¡æŸ¥è¯¢çŠ¶æ€æ—¶ï¼Œç”ŸæˆAIå»ºè®®
if (job.status === 'pending') {
  console.log(`[API_STATUS | Job ${job.jobId.slice(-8)}] ğŸ”„ Job is 'pending'. Fetching AI style suggestions...`);
  
  // 1. è·å–AIé£æ ¼å»ºè®®
  const aiSuggestions = await getStyleSuggestionFromAI({...});
  
  // 2. åˆ›å»ºsuggestionsæ•°ç»„ï¼Œæ¯ä¸ªåˆå§‹çŠ¶æ€ä¸º'pending'
  job.suggestions = aiSuggestions.map((suggestion, index) => ({
    index,
    status: 'pending', // æ¯ä¸ªå»ºè®®åˆå§‹ä¸ºpending
    styleSuggestion: suggestion,
    personaProfile: {},
    finalPrompt: "Generated styling suggestion",
  }));

  // 3. è‡ªåŠ¨å¯åŠ¨ç¬¬ä¸€ä¸ªå»ºè®®çš„å›¾åƒç”Ÿæˆ
  if (job.suggestions[0]) {
    console.log(`[API_STATUS | Job ${job.jobId.slice(-8)}] ğŸš€ Auto-triggering first suggestion after AI suggestions generated.`);
    job.suggestions[0].status = 'generating_images';
    
    // ç«‹å³å¯åŠ¨pipeline
    runImageGenerationPipeline(job.jobId, 0);
    console.log(`[API_STATUS | Job ${job.jobId.slice(-8)}] ğŸš€ Pipeline started in background for suggestion 0.`);
  }
}
```

**å…³é”®è®¾è®¡**:
- è‡ªåŠ¨å¯åŠ¨**ç¬¬ä¸€ä¸ªå»ºè®®**çš„å›¾åƒç”Ÿæˆ
- å…¶ä»–å»ºè®®ä¿æŒ`'pending'`çŠ¶æ€
- ç”¨æˆ·å¯ç«‹å³çœ‹åˆ°æ–‡å­—å»ºè®®ï¼ŒåŒæ—¶ç¬¬ä¸€ä¸ªå»ºè®®å¼€å§‹ç”Ÿæˆå›¾ç‰‡

### é˜¶æ®µ3: `/api/generation/start-image-task/route.ts` - ç”¨æˆ·é€‰æ‹©é˜¶æ®µ

**åŠŸèƒ½**: ä¸ºç‰¹å®šå»ºè®®å¯åŠ¨å›¾åƒç”Ÿæˆä»»åŠ¡
**ç›®æ ‡**: æŒ‰éœ€å¤„ç†ï¼Œç”¨æˆ·æ§åˆ¶

```typescript
// æ£€æŸ¥ç›®æ ‡å»ºè®®çŠ¶æ€
if (job.suggestions[suggestionIndex]?.status !== 'pending') {
  const currentStatus = job.suggestions[suggestionIndex]?.status || 'not found';
  console.log(`[API | start-image-task] Suggestion ${suggestionIndex} is not pending (status: ${currentStatus}). Ignoring request.`);
  return NextResponse.json({ message: `Suggestion is already being processed or is complete. Status: ${currentStatus}` });
}

// æ›´æ–°çŠ¶æ€å¹¶å¯åŠ¨pipeline
job.suggestions[suggestionIndex].status = 'generating_images';
job.updatedAt = Date.now();

await kv.set(jobId, job);
console.log(`[API | start-image-task] Updated suggestion ${suggestionIndex} status to 'generating_images'.`);

// ä½¿ç”¨å…±äº«çš„pipeline runner
runImageGenerationPipeline(jobId, suggestionIndex);
console.log(`[API | start-image-task] Background pipeline started for suggestion ${suggestionIndex}.`);
```

**è§¦å‘åœºæ™¯**:
- ç”¨æˆ·åœ¨UIä¸­é€‰æ‹©ä¸€ä¸ªçŠ¶æ€ä¸ºpendingçš„suggestion
- ä»`useGeneration.ts`çš„`selectSuggestion`å‡½æ•°è°ƒç”¨

## 3. å®Œæ•´å·¥ä½œæµç¨‹

### å‰ç«¯è°ƒç”¨æµç¨‹

```typescript
// 1. ç”¨æˆ·å‘èµ·ç”Ÿæˆè¯·æ±‚
const startGeneration = async () => {
  const response = await fetch("/api/generation/start", {
    method: "POST",
    body: formData, // åŒ…å«å›¾ç‰‡ã€åœºåˆã€æ¨¡å¼ç­‰
  });
  const { jobId } = await response.json();
  // ç«‹å³è·å¾—jobIdï¼Œå¼€å§‹è½®è¯¢
};

// 2. è½®è¯¢çŠ¶æ€ï¼Œè·å–å»ºè®®
const onPollingUpdate = (job: Job) => {
  if (job.suggestions.length > 0) {
    // æ˜¾ç¤ºå»ºè®®åˆ—è¡¨
    setSuggestions(job.suggestions);
  }
};

// 3. ç”¨æˆ·é€‰æ‹©ç‰¹å®šå»ºè®®
const selectSuggestion = async (index: number) => {
  const selected = suggestions[index];
  if (selected.status === 'pending') {
    // è°ƒç”¨start-image-taskå¯åŠ¨å›¾åƒç”Ÿæˆ
    const response = await fetch('/api/generation/start-image-task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jobId: currentJob.jobId, suggestionIndex: index }),
    });
  }
};
```

### åç«¯å¤„ç†æµç¨‹

```typescript
// 1. ä»»åŠ¡åˆ›å»º (start/route.ts)
POST /api/generation/start
â”œâ”€â”€ ä¸Šä¼ å›¾ç‰‡åˆ°blobå­˜å‚¨
â”œâ”€â”€ åˆ›å»ºJobå¯¹è±¡ (status: 'pending', suggestions: [])
â”œâ”€â”€ è¿›è¡Œç”¨æˆ·ä»»åŠ¡æ•°é‡é™åˆ¶æ£€æŸ¥
â””â”€â”€ è¿”å›jobId (å¿«é€Ÿå“åº”)

// 2. çŠ¶æ€æŸ¥è¯¢ (status/route.ts)  
GET /api/generation/status?jobId=xxx
â”œâ”€â”€ æ£€æŸ¥jobçŠ¶æ€
â”œâ”€â”€ å¦‚æœpending: ç”ŸæˆAIå»ºè®®
â”œâ”€â”€ è‡ªåŠ¨å¯åŠ¨ç¬¬ä¸€ä¸ªå»ºè®®çš„å›¾åƒç”Ÿæˆ
â””â”€â”€ è¿”å›å»ºè®®åˆ—è¡¨

// 3. ç”¨æˆ·é€‰æ‹© (start-image-task/route.ts)
POST /api/generation/start-image-task
â”œâ”€â”€ éªŒè¯å»ºè®®çŠ¶æ€
â”œâ”€â”€ æ›´æ–°çŠ¶æ€ä¸º'generating_images'
â”œâ”€â”€ å¯åŠ¨å›¾åƒç”Ÿæˆpipeline
â””â”€â”€ è¿”å›ç¡®è®¤æ¶ˆæ¯
```

## 4. æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Start as /api/generation/start
    participant Status as /api/generation/status
    participant ImageTask as /api/generation/start-image-task
    participant Pipeline as runImageGenerationPipeline
    participant KV as Vercel KV
    participant Blob as Vercel Blob

    Note over User,Blob: é˜¶æ®µ1: ä»»åŠ¡åˆ›å»º
    User->>Start: æäº¤ç”Ÿæˆè¯·æ±‚ (å›¾ç‰‡+å‚æ•°)
    Start->>Blob: ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
    Blob-->>Start: è¿”å›å›¾ç‰‡URL
    Start->>KV: åˆ›å»ºJobè®°å½• (pendingçŠ¶æ€)
    KV-->>Start: ç¡®è®¤ä¿å­˜
    Start-->>User: è¿”å›jobId (å¿«é€Ÿå“åº”)

    Note over User,Blob: é˜¶æ®µ2: å»ºè®®ç”Ÿæˆ
    User->>Status: è½®è¯¢çŠ¶æ€ (é¦–æ¬¡)
    Status->>KV: è·å–Jobæ•°æ®
    KV-->>Status: è¿”å›pendingçŠ¶æ€çš„Job
    Status->>Status: ç”ŸæˆAIé£æ ¼å»ºè®®
    Status->>Pipeline: å¯åŠ¨ç¬¬ä¸€ä¸ªå»ºè®®çš„å›¾åƒç”Ÿæˆ
    Status->>KV: æ›´æ–°Job (processingçŠ¶æ€ + suggestions)
    KV-->>Status: ç¡®è®¤æ›´æ–°
    Status-->>User: è¿”å›å»ºè®®åˆ—è¡¨

    Note over User,Blob: é˜¶æ®µ3: ç”¨æˆ·é€‰æ‹©
    User->>ImageTask: é€‰æ‹©å…¶ä»–å»ºè®® (suggestionIndex)
    ImageTask->>KV: è·å–Jobæ•°æ®
    KV-->>ImageTask: è¿”å›Job
    ImageTask->>ImageTask: éªŒè¯å»ºè®®çŠ¶æ€ (pending)
    ImageTask->>KV: æ›´æ–°å»ºè®®çŠ¶æ€ (generating_images)
    KV-->>ImageTask: ç¡®è®¤æ›´æ–°
    ImageTask->>Pipeline: å¯åŠ¨é€‰ä¸­å»ºè®®çš„å›¾åƒç”Ÿæˆ
    ImageTask-->>User: è¿”å›ç¡®è®¤æ¶ˆæ¯

    Note over User,Blob: é˜¶æ®µ4: ç»“æœè½®è¯¢
    loop è½®è¯¢ç›´åˆ°å®Œæˆ
        User->>Status: è½®è¯¢çŠ¶æ€
        Status->>KV: è·å–Jobæ•°æ®
        KV-->>Status: è¿”å›æœ€æ–°çŠ¶æ€
        Status-->>User: è¿”å›è¿›åº¦æ›´æ–°
    end
```

## 5. å¹¶å‘æ§åˆ¶æœºåˆ¶

### Pipelineé”æœºåˆ¶

```typescript
// é˜²æ­¢é‡å¤æ‰§è¡Œçš„é”æœºåˆ¶
const pipelineLockKey = `pipeline_lock:${jobId}:${suggestionIndex}`;
const existingLock = await kv.get(pipelineLockKey);
if (existingLock) {
  console.log(`[PIPELINE_RUNNER] âš ï¸ PIPELINE ALREADY RUNNING - Skipping duplicate execution`);
  return;
}

// è®¾ç½®pipelineè¿è¡Œé” (5åˆ†é’Ÿè¿‡æœŸ)
await kv.set(pipelineLockKey, `started_at_${Date.now()}`, { ex: 300 });
```

### çŠ¶æ€æ£€æŸ¥æœºåˆ¶

```typescript
// æ£€æŸ¥å»ºè®®çŠ¶æ€ï¼Œé¿å…é‡å¤å¤„ç†
if (suggestionToProcess.status === 'succeeded' || suggestionToProcess.status === 'failed') {
  console.log(`[PIPELINE_RUNNER] âš ï¸ Suggestion ${suggestionIndex} already processed (${suggestionToProcess.status}) - Skipping`);
  await kv.del(pipelineLockKey);
  return;
}
```

## 6. æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### å“åº”æ—¶é—´å¯¹æ¯”

| æŒ‡æ ‡ | ä¼ ç»Ÿæ¶æ„ | åˆ†é˜¶æ®µæ¶æ„ |
|------|---------|-----------|
| ä»»åŠ¡åˆ›å»ºå“åº”æ—¶é—´ | 30-90ç§’ | < 2ç§’ |
| é¦–æ¬¡å†…å®¹å±•ç¤º | ç­‰å¾…æ‰€æœ‰å¤„ç†å®Œæˆ | ç«‹å³æ˜¾ç¤ºå»ºè®® |
| ç”¨æˆ·äº¤äº’æ€§ | æ—  | å¯é€‰æ‹©æ„Ÿå…´è¶£çš„å»ºè®® |
| èµ„æºåˆ©ç”¨ç‡ | ä¸€æ¬¡æ€§æ¶ˆè€—æ‰€æœ‰èµ„æº | æŒ‰éœ€åˆ†é…èµ„æº |

### ç”¨æˆ·ä½“éªŒæå‡

1. **å³æ—¶åé¦ˆ**: ç”¨æˆ·æäº¤åç«‹å³è·å¾—jobIdï¼ŒçŸ¥é“è¯·æ±‚å·²è¢«æ¥æ”¶
2. **æ¸è¿›å¼å†…å®¹**: å…ˆçœ‹åˆ°æ–‡å­—å»ºè®®ï¼Œå†é€‰æ‹©ç”Ÿæˆå›¾ç‰‡
3. **é€‰æ‹©æ€§ç”Ÿæˆ**: åªç”Ÿæˆç”¨æˆ·å…³å¿ƒçš„å†…å®¹ï¼Œé¿å…æµªè´¹
4. **å®¹é”™æ€§å¼º**: å•ä¸ªå»ºè®®å¤±è´¥ä¸å½±å“å…¶ä»–å»ºè®®

## 7. å®æ–½å»ºè®®

### ç›‘æ§æŒ‡æ ‡

```typescript
// å…³é”®æ€§èƒ½æŒ‡æ ‡
const metrics = {
  taskCreationTime: 'start APIå“åº”æ—¶é—´',
  firstSuggestionTime: 'é¦–æ¬¡å»ºè®®ç”Ÿæˆæ—¶é—´', 
  userSelectionTime: 'ç”¨æˆ·é€‰æ‹©åˆ°å¯åŠ¨æ—¶é—´',
  pipelineExecutionTime: 'pipelineæ‰§è¡Œæ—¶é—´',
  overallCompletionTime: 'æ•´ä½“å®Œæˆæ—¶é—´'
};
```

### é”™è¯¯å¤„ç†

```typescript
// å„é˜¶æ®µçš„é”™è¯¯æ¢å¤æœºåˆ¶
const errorHandling = {
  taskCreation: 'é‡è¯•ä¸Šä¼ ï¼Œæ¸…ç†éƒ¨åˆ†æ•°æ®',
  suggestionGeneration: 'é‡è¯•AIè°ƒç”¨ï¼Œé™çº§åˆ°ç®€å•å»ºè®®',
  pipelineExecution: 'é‡è¯•pipelineï¼Œæ¸…ç†é”çŠ¶æ€',
  userSelection: 'éªŒè¯çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤è§¦å‘'
};
```

## 8. å¤–éƒ¨LLMæ¨¡å‹è°ƒç”¨é˜¶æ®µåˆ†æ

### OpenAI APIè°ƒç”¨é˜¶æ®µ

#### é˜¶æ®µ2: å»ºè®®ç”Ÿæˆé˜¶æ®µ (`/api/generation/status/route.ts`)

**è°ƒç”¨æ—¶æœº**: é¦–æ¬¡çŠ¶æ€æŸ¥è¯¢æ—¶ï¼Œå½“JobçŠ¶æ€ä¸º`'pending'`
**è°ƒç”¨å‡½æ•°**: `getStyleSuggestionFromAI()`
**APIç«¯ç‚¹**: `openai.chat.completions.create()`
**æ¨¡å‹**: `gpt-4o`

```typescript
// åœ¨status/route.tsä¸­è°ƒç”¨
const aiSuggestions = await getStyleSuggestionFromAI(
  {
    humanImageUrl: job.input.humanImage.url,
    garmentImageUrl: job.input.garmentImage.url,
    occasion: job.input.occasion,
    userProfile: userProfile,
    stylePrompt: job.input.stylePrompt, // åœºæ™¯é£æ ¼æç¤º
    customPrompt: job.input.customPrompt, // ç”¨æˆ·è‡ªå®šä¹‰éœ€æ±‚
  },
  { count: 3 } // ç”Ÿæˆ3ä¸ªå»ºè®®
);
```

**åŠŸèƒ½**: 
- åˆ†æç”¨æˆ·ç…§ç‰‡å’Œæœè£…å›¾ç‰‡
- ç”Ÿæˆ3å¥—ä¸åŒçš„é£æ ¼å»ºè®®
- ä¸ºæ¯ä¸ªå»ºè®®ç”Ÿæˆ`image_prompt`ç”¨äºåç»­å›¾åƒç”Ÿæˆ
- è¿”å›ç»“æ„åŒ–çš„JSONå»ºè®®

**è¾“å…¥æ•°æ®**:
- ç”¨æˆ·ç…§ç‰‡URL
- æœè£…å›¾ç‰‡URL  
- åœºåˆä¿¡æ¯
- ç”¨æˆ·ç”»åƒæ•°æ®
- åœºæ™¯é£æ ¼æç¤º
- ç”¨æˆ·è‡ªå®šä¹‰éœ€æ±‚

**è¾“å‡ºæ•°æ®**:
```typescript
{
  suggestions: [
    {
      outfit_suggestion: {
        outfit_title: "ä¼˜é›…å•†åŠ¡é£",
        explanation: "é€‚åˆåŠå…¬å®¤çš„æ­£å¼æ­é…...",
        items: { tops: [...], bottoms: [...] }
      },
      image_prompt: "A professional woman in business attire..."
    },
    // ... å…¶ä»–2ä¸ªå»ºè®®
  ]
}
```

### Kling AI APIè°ƒç”¨é˜¶æ®µ

#### é˜¶æ®µ3: å›¾åƒç”Ÿæˆé˜¶æ®µ (`runImageGenerationPipeline`)

**è°ƒç”¨æ—¶æœº**: ç”¨æˆ·é€‰æ‹©å»ºè®®åï¼Œæˆ–è‡ªåŠ¨å¯åŠ¨ç¬¬ä¸€ä¸ªå»ºè®®æ—¶
**è°ƒç”¨å‡½æ•°**: `runStylizationMultiple()` å’Œ `runVirtualTryOnMultiple()`

##### é£æ ¼åŒ–é˜¶æ®µ (Stylization)

**APIç«¯ç‚¹**: `/v1/images/generations`
**æ¨¡å‹**: `kling-v1-5` æˆ– `kling-v2`
**è°ƒç”¨å‡½æ•°**: `runStylizationMultiple()`

```typescript
// åœ¨pipelineä¸­è°ƒç”¨
const stylizationResult = await runStylizationMultiple(
  'kling-v1-5', // æˆ– 'kling-v2'
  suggestion, // åŒ…å«image_promptçš„å»ºè®®
  job.input.humanImage.url,
  job.input.humanImage.name,
  job.input.humanImage.type,
  job
);
```

**åŠŸèƒ½**:
- ä½¿ç”¨OpenAIç”Ÿæˆçš„`image_prompt`
- å°†ç”¨æˆ·ç…§ç‰‡è¿›è¡Œé£æ ¼åŒ–å¤„ç†
- ç”Ÿæˆåœºæ™¯åŒ–çš„èƒŒæ™¯å’Œå§¿åŠ¿
- è¿”å›é£æ ¼åŒ–å›¾ç‰‡URLs

**è¾“å…¥æ•°æ®**:
- ç”¨æˆ·ç…§ç‰‡ (Base64ç¼–ç )
- é£æ ¼åŒ–æç¤ºè¯ (æ¥è‡ªOpenAIçš„image_prompt)
- æ¨¡å‹ç‰ˆæœ¬é€‰æ‹©

**è¾“å‡ºæ•°æ®**:
```typescript
{
  imageUrls: ["https://...", "https://..."],
  finalPrompt: "å®Œæ•´çš„æœ€ç»ˆæç¤ºè¯"
}
```

##### è™šæ‹Ÿè¯•ç©¿é˜¶æ®µ (Virtual Try-On)

**APIç«¯ç‚¹**: `/v1/images/kolors-virtual-try-on`
**æ¨¡å‹**: `kolors-virtual-try-on-v1-5`
**è°ƒç”¨å‡½æ•°**: `runVirtualTryOnMultiple()`

```typescript
// åœ¨pipelineä¸­è°ƒç”¨
const tryOnImageUrls = await runVirtualTryOnMultiple(
  styledImageUrl, // é£æ ¼åŒ–åçš„å›¾ç‰‡ä½œä¸ºç”»å¸ƒ
  job.input.garmentImage.url, // æœè£…å›¾ç‰‡
  job.input.garmentImage.name,
  job.input.garmentImage.type
);
```

**åŠŸèƒ½**:
- å°†æœè£…è™šæ‹Ÿè¯•ç©¿åˆ°é£æ ¼åŒ–å›¾ç‰‡ä¸Š
- ä¿æŒæœè£…çš„åŸå§‹ç‰¹å¾
- ç”Ÿæˆæœ€ç»ˆçš„è¯•ç©¿æ•ˆæœå›¾

**è¾“å…¥æ•°æ®**:
- é£æ ¼åŒ–å›¾ç‰‡ (ä½œä¸ºç”»å¸ƒ)
- æœè£…å›¾ç‰‡ (Base64ç¼–ç )
- è¯•ç©¿æ¨¡å‹å‚æ•°

**è¾“å‡ºæ•°æ®**:
```typescript
["https://tryon-image-1.jpg", "https://tryon-image-2.jpg"]
```

### ä¸åŒç”Ÿæˆæ¨¡å¼çš„APIè°ƒç”¨å·®å¼‚

#### 1. Try-On Onlyæ¨¡å¼
```typescript
// åªè°ƒç”¨è™šæ‹Ÿè¯•ç©¿API
const tryOnImageUrls = await runVirtualTryOnMultiple(
  job.input.humanImage.url, // ç›´æ¥åœ¨åŸå§‹äººåƒä¸Šè¯•ç©¿
  job.input.garmentImage.url,
  job.input.garmentImage.name,
  job.input.garmentImage.type
);
```

#### 2. Simple Sceneæ¨¡å¼
```typescript
// 1. å…ˆè°ƒç”¨é£æ ¼åŒ–API
const stylizationResult = await runStylizationMultiple(...);
// 2. å†å¯¹æ¯ä¸ªé£æ ¼åŒ–å›¾ç‰‡è°ƒç”¨è™šæ‹Ÿè¯•ç©¿API
for (const styledImage of stylizationResult.imageUrls) {
  const tryOnImages = await runVirtualTryOnMultiple(styledImage, ...);
}
```

#### 3. Advanced Sceneæ¨¡å¼
```typescript
// 1. ä½¿ç”¨é«˜çº§æ¨¡å‹è¿›è¡Œé£æ ¼åŒ–
const stylizationResult = await runStylizationMultiple('kling-v2', ...);
// 2. å¯¹æ¯ä¸ªé£æ ¼åŒ–å›¾ç‰‡è¿›è¡Œè™šæ‹Ÿè¯•ç©¿
for (const styledImage of stylizationResult.imageUrls) {
  const tryOnImages = await runVirtualTryOnMultiple(styledImage, ...);
}
// 3. å¯é€‰ï¼šäººè„¸æ›¿æ¢ (Face Swap API)
for (const tryOnImage of allTryOnImages) {
  const swappedImage = await runFaceSwap(tryOnImage, ...);
}
```

### APIè°ƒç”¨æˆæœ¬åˆ†æ

| é˜¶æ®µ | APIè°ƒç”¨ | æ¨¡å‹ | æˆæœ¬ | é¢‘ç‡ |
|------|---------|------|------|------|
| å»ºè®®ç”Ÿæˆ | OpenAI GPT-4o | gpt-4o | ä¸­ç­‰ | æ¯ä»»åŠ¡1æ¬¡ |
| é£æ ¼åŒ– | Kling AI | kling-v1-5/v2 | é«˜ | æ¯å»ºè®®1æ¬¡ |
| è™šæ‹Ÿè¯•ç©¿ | Kling AI | kolors-virtual-try-on-v1-5 | æœ€é«˜ | æ¯é£æ ¼åŒ–å›¾ç‰‡1æ¬¡ |
| äººè„¸æ›¿æ¢ | Face Swap API | - | ä¸­ç­‰ | å¯é€‰ |

### ç¯å¢ƒæ§åˆ¶æœºåˆ¶

#### å¼€å‘ç¯å¢ƒä¼˜åŒ–
```typescript
// åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œè™šæ‹Ÿè¯•ç©¿APIè¢«æ¨¡æ‹Ÿ
if (process.env.MOCK_VIRTUAL_TRYON === 'true') {
  // è¿”å›æ¨¡æ‹Ÿçš„è¯•ç©¿å›¾ç‰‡
  return mockTryOnImageUrls;
} else {
  // è°ƒç”¨çœŸå®çš„Kling AI API
  return await executeKlingTask(KOLORS_VIRTUAL_TRYON_SUBMIT_PATH, ...);
}
```

#### ç”Ÿäº§ç¯å¢ƒ
- æ‰€æœ‰APIè°ƒç”¨éƒ½æ˜¯çœŸå®çš„
- å®Œæ•´çš„å›¾åƒç”Ÿæˆæµç¨‹
- å®æ—¶æˆæœ¬ç›‘æ§

è¿™ç§åˆ†é˜¶æ®µå»¶è¿ŸåŠ è½½æ¶æ„å®ç°äº†**ç”¨æˆ·ä½“éªŒ**å’Œ**èµ„æºæ•ˆç‡**çš„æœ€ä½³å¹³è¡¡ï¼Œæ˜¯ç°ä»£AIåº”ç”¨çš„æœ€ä½³å®è·µã€‚ 